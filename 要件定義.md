# Google Calendar自動登録アプリ 要件定義書

## 1. 文書情報
- 文書名: Google Calendar自動登録アプリ 要件定義書
- 作成日: 2026-02-13（最終更新: 2026-02-16）
- バージョン: 1.3（確定版）
- 状態: 確定
- 対象OS: macOS（優先）

## 2. 背景と目的
日常的にLINEやメール文面などの自然文から予定をGoogleカレンダーへ登録する作業が煩雑である。  
本アプリは、グローバルショートカットで即時入力UIを前面表示し、入力内容を必要に応じてGemini APIで整形・構造化したうえでGoogle Calendar APIへ自動登録し、予定登録までの手間を最小化することを目的とする。
厳密な固定出力より、少ない操作で実用的に登録できることを優先する。

## 3. スコープ
### 3.1 対象
- デスクトップ常駐アプリ（macOS）
- グローバルショートカットによる入力ウィンドウ呼び出し
- 自然文入力から予定作成（直接登録またはGemini整形経由）
- Googleカレンダーへのイベント登録
- 設定画面（`Cmd + ,`）による各種設定

### 3.2 非対象（初期リリース）
- モバイルアプリ（iOS/Android）
- 複数Googleアカウントの高度な切替UI
- チーム向け承認ワークフロー
- 音声入力

## 4. 用語定義
- クイック入力ウィンドウ: ショートカットで呼び出される最前面の入力UI
- 自然文: LINE/メール本文等の自由記述テキスト
- 構造化データ: タイトル・開始日時・終了日時・場所・詳細などのイベント項目

## 5. 想定ユーザー
- 個人ユーザー（1人運用）
- 日程調整メッセージを頻繁にGoogleカレンダーへ転記するユーザー

## 6. ユースケース
1. ユーザーがグローバルショートカットを押す
2. アプリが最前面に表示され、カーソルフォーカス済みの入力欄が開く
3. ユーザーが自然文または簡易メモを入力して送信
4. アプリが入力を解析（必要時はGemini API呼び出し）
5. Google Calendar APIで予定を登録
6. 成功/失敗をユーザーへ通知

## 7. 機能要件
### FR-01 アプリ起動・常駐
- OSログイン後に任意で自動起動できる
- メニューバー常駐またはバックグラウンド常駐ができる

### FR-02 グローバルショートカット起動
- ユーザー定義のショートカットでクイック入力ウィンドウを開く
- ウィンドウは常に最前面（他アプリより前）で表示する
- ショートカット押下時、現在の作業スペースを維持したまま入力可能状態で前面表示する（Spaceの強制切替をしない）
- 複数ディスプレイ利用時は、マウスカーソルがあるディスプレイに表示する（Raycastライクな挙動）
- 表示時にテキスト入力欄へ自動フォーカスする
- フォーカスを失ったら自動的に非表示にする（Hide on Blur）

### FR-03 クイック入力
- 単一テキストエリアに自由記述入力できる
- `Cmd + Enter`（または送信ボタン）で登録処理を開始する
- `Enter` / `Shift + Enter` は改行として扱う
- `Escape` でクイック入力を閉じる（非表示）
- `Cmd + Shift + O` で新しいチャットへ移行する（会話/聞き返し状態/添付をリセット）
- 画像添付（ファイル選択または貼り付け）を受け付ける
- 画像添付時は画像内テキストを解釈対象に含める（OCR相当）
- 送信中はローディング表示を行う

### FR-12 クイック入力の視覚仕様（デザインUX）
- `デザインUX.md` をクイック入力/設定画面の一次仕様として扱う
- 外形は検索バー型（角丸 `16px`）とし、透明黒のガラス板（Blur/Saturate + 微小グラデーション）で表現する
- 外枠と中身の間に別レイヤーを作らず「一枚板」に見えること（ズレて見せない）
- 空状態は1行Composer（左: 画像添付、中央: 入力、右: 送信）
- 入力エリアのプレースホルダー文言は `質問してみましょう` とする
- 履歴がある場合のみ会話リストを表示し、ウィンドウ高は内容に追従して不要な余白を作らない（最大 `600px`）
- 送信ボタンは視認性の高いアクセント（白背景のアイコンボタン）で表現してよい
- 画像入力とテキスト入力を同列に扱うマルチモーダル導線を維持する

### FR-04 入力モード
- MVPでは AI整形登録（Gemini解釈）を常時使用する
- 将来的に「直接登録（ユーザーがタイトル・日時を明示）」を追加できる設計とする

### FR-05 Gemini連携
- 入力テキストから以下項目を抽出する
  - タイトル
  - 開始日時
  - 終了日時（未指定時はデフォルト補完）
  - 場所（任意）
  - 説明（任意）
- 日時曖昧表現（例: 来週木曜夕方）をローカルタイムゾーンで解釈する
- MVPでは、設定画面で編集できる「カスタム指示（自由記述）」を入力補助として参照する
- カスタム指示例: `食事は2時間で登録してね` のような軽い記述をそのまま使える
- 厳密な決定論的一致は必須とせず、実用上妥当なベストエフォート解釈を採用する
- 解釈不能または解釈に不確実性が高い場合は、登録前に聞き返しUIで確認を行う

### FR-06 Google Calendar連携
- OAuth認証でGoogleアカウントを接続する
- MVPでは登録先カレンダーは `primary` に固定する（将来、設定画面で選択可能に拡張）
- イベント作成APIで予定を1件登録する
- 成功時にイベントURLまたは登録結果を表示する

### FR-07 設定画面
- `Cmd + ,` で設定画面を開く
- 以下を設定/操作できる
  - Google連携状態（接続/解除）
  - Gemini APIキー（保存先: Keychain）
  - 使用モデル（プリセット/カスタム入力）
  - 起動ショートカット（記録/既定値に戻す）
  - Geminiに渡す固定プロンプト（カスタム指示）
  - 診断ログ（パス表示/再読み込み/ログファイルを開く）
- 設定画面は縦スクロールできる
- デザインはクイック入力と同一のガラス板テーマに統一する

### FR-10 Gem風カスタム指示管理
- Geminiに渡すカスタム指示を、ユーザーが自然文で自由記述できる
- 例: `食事は2時間で登録してね` のような軽い記述をそのまま使える
- 厳密なDSLや正確なフォーマット強制はしない
- MVPでは単一の指示テキストとして保存し、Geminiリクエストに常に付与する
- 将来的にプリセット管理（複数保存/切替/プレビュー）へ拡張できる設計とする

### FR-11 聞き返しフロー
- 以下の条件では登録前に聞き返しを行う
  - 日付または時刻が確定できない
  - 開始/終了の整合性が取れない
  - 必須項目（タイトル、開始、終了）が欠ける
- 聞き返しは1-2問で完了する短いUIとし、回答後に再解釈して登録する
- 聞き返し回数に上限は設けず、Googleカレンダー登録に必要な情報がそろうまで継続する
- ユーザーは任意のタイミングで手動編集モードへ切り替えられる
- ユーザーがキャンセルした場合は登録しない

### FR-08 通知・エラーハンドリング
- 成功時はトースト通知を表示する
- 失敗時は原因（認証切れ、日時解釈失敗、APIエラー等）を表示する
- 再試行導線を提供する
- 聞き返しが必要な場合は確認UIを最優先表示する

### FR-09 履歴（MVPでは簡易）
- 直近登録結果を最低5件まで確認できる（任意）

## 8. 非機能要件
### NFR-01 デザイン
- 透明でクリアなUI（ガラス調）を採用する
- 視認性確保のため背景ぼかし・適切なコントラストを持つ
- ミニマルで入力に集中できるレイアウト
- カラーパレットはモノトーン（Black/Dark Gray/Light Gray/White）を基本とし、不要なアクセント色を使わない
- 外枠は細い明色ボーダー（例: `1px solid rgba(255, 255, 255, 0.2)`）で、背景との境界を明確にする
- 主要UI要素間の余白は均等（目安 12-16px）を維持し、窮屈さを避ける

### NFR-02 パフォーマンス
- ショートカット押下から入力可能状態まで1秒以内を目標
- 送信から結果通知まで5秒以内（API応答依存）

### NFR-03 可用性
- API障害時もアプリが落ちない
- 失敗時に操作継続できる

### NFR-04 セキュリティ
- 秘密情報（Gemini APIキー、OAuthアクセストークン、OAuthリフレッシュトークン）はmacOS Keychainに保存する
- 非秘密設定（ショートカット、カスタム指示、プリセット、表示設定）は`Application Support`配下の設定ファイルに保存する
- 機密情報を平文でログ出力しない

### NFR-05 保守性
- API連携層（Gemini/Google）を分離し、差し替え可能な設計とする

### NFR-06 操作体験
- どのアプリ利用中でもショートカット一発で入力ウィンドウが前面に出る体験を優先する
- 複数ディスプレイでも、表示位置は現在のカーソル位置に追従する

## 9. 画面要件
### 9.1 クイック入力ウィンドウ
- 最前面表示（表示中は他アプリより前）
- 透明背景 + ぼかし
- 検索バー型コンテナ（角丸 `16px` / ガラス板テーマ。詳細は `デザインUX.md`）
- 空状態: 1行Composer（左: 画像添付、中央: 入力、右: 送信）
- 履歴あり: 上部に会話リスト + 下部Composer
- `Cmd + Enter` 送信 / `Enter`・`Shift + Enter` 改行
- `Escape` で閉じる（非表示）
- フォーカスが外れたら自動で非表示（Hide on Blur）
- `Cmd + Shift + O` で新しいチャットへ移行
- 複数ディスプレイ時はマウスカーソル所在ディスプレイに表示
- ステータス表示（待機中/送信中/成功/失敗）
- 画像入力とテキスト入力が同一画面内で連続操作できること
- 背景領域はドラッグで移動できる（入力欄/ボタン等の操作要素は除外）

### 9.2 設定画面
- セクション（MVP）
  - Google連携
  - 起動ショートカット
  - Gemini（APIキー/モデル）
  - カスタム指示
  - 診断ログ
- `Cmd + ,` で開く
- 縦スクロール可能
- 上部にドラッグ領域（32px）を設け、スクロール操作を阻害しない

## 10. データ要件
### 10.1 入力データ
- 自然文テキスト（最大文字数は実装側で制限）

### 10.2 生成イベントデータ
- `title`（必須）
- `start`（必須）
- `end`（必須）
- `location`（任意）
- `description`（任意）
- `calendarId`（必須）

### 10.3 ルール・指示設定データ
（MVP）
- `geminiInstruction`（自由記述テキスト）
- `model`（使用モデル）
- `shortcut`（起動ショートカット）

## 11. 外部インターフェース要件
### 11.1 Gemini API
- 用途: 自然文から予定情報への整形・抽出
- 入力: ユーザー自由文
- 入力補助: カスタム指示（自由記述）
- 出力: JSON形式の構造化データ（ベストエフォート）
- 構造化が不十分な場合はアプリ側で聞き返しフローへ遷移する

### 11.2 Google Calendar API
- 用途: イベント登録
- 主な操作: `events.insert`
- 認証: OAuth 2.0（Desktopアプリ）

## 12. 例外・エッジケース
- 日時が一意に確定できない
- 開始 > 終了
- 過去日時の登録
- 同一内容の重複登録
- Google認証切れ
- ネットワーク不通
- カスタム指示により不正なJSONが生成される
- 聞き返し中にユーザーがキャンセルする

## 13. MVP受け入れ基準
- 任意ショートカットで最前面入力UIが開き、どのアプリ利用中でも入力フォーカスが当たる
- 複数ディスプレイ環境で、マウスカーソル所在ディスプレイに入力UIが表示される
- クイック入力で `Cmd + Enter` により送信できる（`Enter` / `Shift + Enter` は改行）
- `Escape` でクイック入力を閉じられる（非表示）
- `Cmd + Shift + O` で新しいチャットへ移行できる（履歴/状態のリセット）
- クイック入力UIが検索バー型ガラス（`デザインUX.md`）・モノトーン配色・一枚板の見え方を満たす
- クイック入力UIが「左:添付 / 中央:入力 / 右:送信」構成を満たす
- プレースホルダー `質問してみましょう` が空入力時に表示される
- 自由文入力からGemini整形を経由してGoogleカレンダー登録できる
- 解釈不能または不確実な入力時に、登録前に聞き返しが実行される
- `Cmd + ,` で設定画面が開く
- 設定画面でGoogle連携・Geminiキー・ショートカット設定ができる
- 設定画面でGem風カスタム指示を編集し、登録結果に反映できる
- 成功/失敗通知が表示される

## 14. 今後の拡張候補
- 複数カレンダー自動振り分け
- 参加者自動抽出と招待送信
- 定期予定ルール生成
- 音声入力
- Slack/Discord連携

## 15. 確定事項（初期運用値）
- 対応カレンダー: MVPはGoogle Calendarのみ
- 登録前確認ポリシー初期値: 不確実時のみ確認
- 重複判定閾値: 同一`calendarId`内で、正規化した`title`一致かつ`start`時刻が前後30分以内なら「重複候補」として確認する（自動ブロックはしない）
- Gem風カスタム指示: MVPでは単一テキスト（ユーザー編集）として運用する
- 聞き返し回数: 無制限（ユーザーがキャンセルするか、登録に必要な情報がそろうまで継続）

## 16. 改定履歴
- v1.3（2026-02-16）: ChatGPTランチャー風の検索バー型ガラスUIへ更新し、`Cmd+Enter`送信・`Cmd+Shift+O`新規チャット等の操作仕様を反映。設定画面も同一テーマへ統一し、スクロール要件を明文化。
- v1.2（2026-02-16）: `デザインUX.md` の内容をFR/NFR/画面要件/受け入れ基準へ反映し、クイック入力の視覚仕様を明文化
- v1.1（2026-02-13）: 聞き返し回数を無制限に変更し、必要情報がそろうまで継続する仕様へ更新
- v1.0（2026-02-13）: 未確定事項をすべて初期運用値として確定し、要件定義を確定版に更新
