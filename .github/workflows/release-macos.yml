name: Release (macOS)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    defaults:
      run:
        working-directory: app
    env:
      # Build-time OAuth config (embedded into packaged app)
      GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
      GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
      GOOGLE_OAUTH_REDIRECT_URI: ${{ secrets.GOOGLE_OAUTH_REDIRECT_URI }}

      # Notarization credentials (choose one strategy)
      APPLE_NOTARIZE_KEYCHAIN_PROFILE: ${{ secrets.APPLE_NOTARIZE_KEYCHAIN_PROFILE }}
      APPLE_NOTARIZE_KEYCHAIN: ${{ secrets.APPLE_NOTARIZE_KEYCHAIN }}
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate public release surface
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          FORBIDDEN_FILES=("AGENTS.md" "学びと気づきログ.md" "デザインUX.md" "要件定義.md")
          for file in "${FORBIDDEN_FILES[@]}"; do
            if git ls-files --error-unmatch "$file" > /dev/null 2>&1; then
              echo "::error file=$file::公開対象外ファイルがgit追跡されています"
              exit 1
            fi
          done

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: app/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Run checks
        run: npm run check

      - name: Prepare signing certificate (optional)
        env:
          MACOS_CERT_P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          if [ -z "${MACOS_CERT_P12_BASE64:-}" ]; then
            echo "No signing certificate secret found. Skipping codesign setup."
            exit 0
          fi
          CERT_PATH="$RUNNER_TEMP/quick2calendar-cert.p12"
          echo "$MACOS_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH"
          echo "CSC_LINK=$CERT_PATH" >> "$GITHUB_ENV"
          echo "CSC_KEY_PASSWORD=$MACOS_CERT_PASSWORD" >> "$GITHUB_ENV"

      - name: Prepare App Store Connect API key (optional)
        env:
          APPLE_API_KEY_P8_BASE64: ${{ secrets.APPLE_API_KEY_P8_BASE64 }}
        run: |
          if [ -z "${APPLE_API_KEY_P8_BASE64:-}" ]; then
            echo "No App Store Connect API key found. Skipping notarize credentials."
            exit 0
          fi
          KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$APPLE_API_KEY_P8_BASE64" | base64 --decode > "$KEY_PATH"
          echo "APPLE_API_KEY=$KEY_PATH" >> "$GITHUB_ENV"

      - name: Build macOS artifacts
        run: npm run dist:mac:${{ matrix.arch }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.arch }}
          path: |
            app/dist/*.dmg
            app/dist/*.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build-macos
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.zip

